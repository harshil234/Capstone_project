{% extends "base.html" %}

{% block title %}AdVision - AI Chatbot{% endblock %}

{% block content %}
<style>
/* Chatbot Styling */
.message {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.loading {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#chat-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.message .bg-white {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 15px;
    border: 1px solid #e9ecef;
}

.user-message .bg-white {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
    color: white !important;
}

.bot-message .bg-white {
    background: white;
    border-left: 4px solid #28a745;
}

.quick-action-btn {
    transition: all 0.3s ease;
    border-radius: 20px;
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

#message-input {
    border-radius: 25px;
    border: 2px solid #e9ecef;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

#message-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

#send-btn {
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

#send-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Responsive design */
@media (max-width: 768px) {
    .quick-action-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    
    #chat-container {
        height: 300px !important;
    }
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-dark mb-3">
                    <i class="fas fa-comments text-primary me-3"></i>AI Chatbot Assistant
                </h1>
                <p class="lead text-muted">
                    Get instant answers to your advertising questions and marketing advice
                </p>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Chat with AI Assistant
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div id="chat-container" class="mb-4" style="height: 400px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 1rem; background-color: var(--gray-50);">
                        <div class="message bot-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; min-width: 40px;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="bg-white p-3 rounded" style="max-width: 80%;">
                                    <p class="mb-0">Hello! I'm your AI assistant. How can I help you with your advertising and marketing questions today?</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="mb-3">
                        <p class="text-muted mb-2"><small>Quick Actions:</small></p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm quick-action-btn" onclick="sendQuickMessage('How can I improve my CTR?')">
                                <i class="fas fa-chart-line me-1"></i>Improve CTR
                            </button>
                            <button class="btn btn-outline-success btn-sm quick-action-btn" onclick="sendQuickMessage('What is a good ROI for ads?')">
                                <i class="fas fa-calculator me-1"></i>ROI Advice
                            </button>
                            <button class="btn btn-outline-warning btn-sm quick-action-btn" onclick="sendQuickMessage('How to write better ad copy?')">
                                <i class="fas fa-pen me-1"></i>Ad Copy Tips
                            </button>
                            <button class="btn btn-outline-info btn-sm quick-action-btn" onclick="sendQuickMessage('Best practices for ad targeting?')">
                                <i class="fas fa-bullseye me-1"></i>Targeting Tips
                            </button>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-outline-secondary btn-sm quick-action-btn" onclick="sendQuickMessage('What is CPM and how to optimize it?')">
                                <i class="fas fa-dollar-sign me-1"></i>CPM Guide
                            </button>
                            <button class="btn btn-outline-dark btn-sm quick-action-btn" onclick="sendQuickMessage('Facebook vs Google Ads comparison')">
                                <i class="fas fa-globe me-1"></i>Platform Comparison
                            </button>
                            <button class="btn btn-outline-primary btn-sm quick-action-btn" onclick="sendQuickMessage('How to optimize campaign budget?')">
                                <i class="fas fa-coins me-1"></i>Budget Tips
                            </button>
                            <button class="btn btn-outline-success btn-sm quick-action-btn" onclick="sendQuickMessage('Marketing strategy for beginners')">
                                <i class="fas fa-rocket me-1"></i>Strategy Guide
                            </button>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-warning btn-sm quick-action-btn" onclick="sendQuickMessage('Technical setup for ad tracking')">
                                <i class="fas fa-cog me-1"></i>Technical Setup
                            </button>
                            <button class="btn btn-outline-info btn-sm quick-action-btn" onclick="sendQuickMessage('What is AdVision and how does it work?')">
                                <i class="fas fa-robot me-1"></i>About AdVision
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-action-btn" onclick="sendQuickMessage('A/B testing best practices')">
                                <i class="fas fa-flask me-1"></i>A/B Testing
                            </button>
                            <button class="btn btn-outline-dark btn-sm quick-action-btn" onclick="sendQuickMessage('How to analyze campaign performance?')">
                                <i class="fas fa-chart-bar me-1"></i>Performance Analysis
                            </button>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." maxlength="1000">
                        <button id="send-btn" class="btn btn-primary" type="button">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <small class="text-muted">Press Enter to send. Maximum 1000 characters.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
const chatContainer = document.getElementById('chat-container');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');

// Utility Functions
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '1060';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// API Helper function
async function apiCall(endpoint, method = 'GET', data = null) {
    const config = {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        }
    };

    if (data && method !== 'GET') {
        config.body = JSON.stringify(data);
    }

    try {
        const response = await fetch(endpoint, config);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.log('Real API call failed, using enhanced demo mode:', error.message);
    }

    // Enhanced fallback to demo mode
    try {
        if (endpoint === '/api/chat') {
            const message = data.message.toLowerCase();
            let response = "I'm here to help with your marketing questions! ";
            
            // Enhanced response patterns
            if (message.includes('ctr') || message.includes('click')) {
                response = "CTR (Click-Through Rate) is crucial for campaign success. Good CTRs typically range from 2-5% depending on your industry. Focus on compelling headlines, targeted audiences, and A/B testing to improve CTR. Our prediction tool can help estimate CTR based on your targeting choices.";
            } else if (message.includes('roi') || message.includes('return')) {
                response = "ROI is calculated as (Revenue - Ad Spend) / Ad Spend × 100. A good ROI is typically 200%+ for most businesses. Monitor conversion rates, customer lifetime value, and use our ROI calculator for better insights. Focus on optimizing conversion rates and reducing cost per acquisition.";
            } else if (message.includes('copy') || message.includes('ad')) {
                response = "Great ad copy should have: attention-grabbing headlines, clear value propositions, strong CTAs, emotional triggers, and social proof. Use our AI copy generator to create multiple variations and A/B test for best results. Focus on benefits over features.";
            } else if (message.includes('targeting') || message.includes('audience')) {
                response = "Effective targeting involves understanding your ideal customer profile, using lookalike audiences, retargeting website visitors, and testing different demographics and interests. Use detailed targeting options and monitor performance by audience segment.";
            } else if (message.includes('cpm') || message.includes('cost per thousand')) {
                response = "CPM (Cost Per Mille) is the cost per 1,000 impressions. Typical ranges: Facebook $5-15, Instagram $7-20, Google Display $2-10. Improve ad relevance, target broader audiences, and use better creatives to lower CPM.";
            } else if (message.includes('budget') || message.includes('spend')) {
                response = "Start with a small budget to test your campaign, then scale up based on performance. Use our ROI calculator to determine optimal budget allocation. Monitor daily spend limits and use automated bidding strategies for better results.";
            } else if (message.includes('facebook') || message.includes('instagram')) {
                response = "Facebook and Instagram ads work well for brand awareness and engagement. Use high-quality visuals, engaging captions, and test different ad formats. Leverage Stories and Reels for better engagement. Our prediction tool can estimate performance for these platforms.";
            } else if (message.includes('google') || message.includes('search')) {
                response = "Google Ads are great for intent-based targeting. They typically have higher CTR but also higher CPC. Focus on relevant keywords, compelling ad copy, and optimize landing pages. Use our ROI calculator to ensure search campaigns are profitable.";
            } else if (message.includes('optimize') || message.includes('improve')) {
                response = "To improve your ad performance: 1) Test different ad creatives, 2) Optimize targeting, 3) Monitor and adjust based on data, 4) Use our predictions to make informed decisions, 5) Calculate ROI to ensure profitability, 6) A/B test everything.";
            } else if (message.includes('strategy') || message.includes('planning')) {
                response = "Digital marketing strategy involves: Awareness (brand campaigns), Consideration (educational content), Conversion (direct response ads), and Retention (retargeting). Choose appropriate channels, create compelling content, and monitor performance continuously.";
            } else if (message.includes('technical') || message.includes('setup')) {
                response = "Technical setup includes: creating business accounts, setting up tracking pixels, configuring conversion tracking, creating audiences, and monitoring performance. Use UTM parameters, set up proper tracking, and conduct regular audits.";
            } else if (message.includes('advision') || message.includes('platform')) {
                response = "AdVision is an AI-powered advertising analytics platform that helps marketers optimize campaigns. Features include: Performance Prediction, ROI Calculator, AI Copy Generator, Thumbnail Analyzer, and AI Chatbot. It uses machine learning for data-driven recommendations.";
            } else if (message.includes('a/b') || message.includes('test')) {
                response = "A/B testing is crucial for optimization. Test headlines, images, ad formats, targeting options, and landing pages. Monitor conversion rates, use statistical significance, and implement winning variations. Test one variable at a time for accurate results.";
            } else if (message.includes('performance') || message.includes('analytics')) {
                response = "Analyze key metrics: CTR, CPC, CPM, ROAS, quality score, and impression share. Identify top-performing audiences, optimize creatives, improve landing pages, and use automation tools. Regular analysis leads to better optimization.";
            } else if (message.includes('hello') || message.includes('hi')) {
                response = "Hello! I'm your AI marketing assistant. I can help with ad optimization, ROI calculations, copywriting, targeting, strategy, and technical setup. What would you like to know about digital advertising?";
            } else if (message.includes('help') || message.includes('support')) {
                response = "I can help you with: 1) Performance predictions and analysis, 2) ROI calculations and optimization, 3) Ad copy generation and testing, 4) Targeting strategies, 5) Platform-specific advice, 6) Technical setup guidance, 7) Marketing strategy. What specific area do you need help with?";
            } else {
                // Generic but helpful response for any question
                response = `I understand you're asking about "${data.message}". As your AI marketing assistant, I can help with campaign optimization, ROI analysis, ad copy creation, targeting strategies, platform selection, technical setup, and performance analysis. What specific aspect of digital marketing would you like to explore? I'm here to provide detailed, actionable advice!`;
            }
            
            return {
                response: response,
                timestamp: new Date().toISOString()
            };
        }
        
        throw new Error('API endpoint not available in demo mode');
        
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

// Chat Functions
function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} mb-3`;
    
    const icon = isUser ? 'user' : 'robot';
    const bgColor = isUser ? 'bg-primary' : 'bg-secondary';
    const alignClass = isUser ? 'justify-content-end' : 'justify-content-start';
    
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${alignClass}">
            ${!isUser ? `<div class="${bgColor} text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; min-width: 40px;">
                <i class="fas fa-${icon}"></i>
            </div>` : ''}
            <div class="bg-white p-3 rounded" style="max-width: 80%;">
                <p class="mb-0">${content}</p>
            </div>
            ${isUser ? `<div class="${bgColor} text-white rounded-circle d-flex align-items-center justify-content-center ms-3" style="width: 40px; height: 40px; min-width: 40px;">
                <i class="fas fa-${icon}"></i>
            </div>` : ''}
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message bot-message mb-3';
    loadingDiv.id = 'loading';
    loadingDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; min-width: 40px;">
                <i class="fas fa-robot"></i>
            </div>
            <div class="bg-white p-3 rounded">
                <div class="d-flex align-items-center">
                    <div class="loading me-2"></div>
                    <span class="text-muted">Thinking...</span>
                </div>
            </div>
        </div>
    `;
    chatContainer.appendChild(loadingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    addMessage(message, true);
    messageInput.value = '';
    sendBtn.disabled = true;
    showLoading();
    
    try {
        const response = await apiCall('/api/chat', 'POST', { message: message });
        hideLoading();
        addMessage(response.response);
    } catch (error) {
        hideLoading();
        addMessage(`Error: ${error.message}. Please try again later.`, false);
        console.error('Chat error:', error);
    }
    
    sendBtn.disabled = false;
    messageInput.focus();
}

// Quick message function
function sendQuickMessage(message) {
    messageInput.value = message;
    sendMessage();
}

// Event listeners
if (sendBtn) {
    sendBtn.addEventListener('click', sendMessage);
}

if (messageInput) {
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    messageInput.focus();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🤖 AdVision Chatbot Loaded');
    messageInput.focus();
});
</script>
{% endblock %}